{% extends "base.html" %}

{% block title %}Step 2 - 評定スコア生成{% endblock %}

{% block content %}
<div class="step-header">
    <span class="step-number">2</span>
    <h1><i class="fas fa-chart-line"></i> 評定スコア生成</h1>
    <p class="text-muted">レビューCSVから14の評価軸でスコアを生成します</p>
</div>

{% with messages = get_flashed_messages() %}
    {% if messages %}
        <div class="alert alert-{{ 'danger' if 'エラー' in messages[-1] else 'success' }} alert-dismissible fade show" role="alert">
            <i class="fas fa-{{ 'exclamation-triangle' if 'エラー' in messages[-1] else 'check-circle' }}"></i>
            {{ messages[-1] }}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    {% endif %}
{% endwith %}

<form method="post" class="needs-validation" novalidate>
    <div class="row">
        <div class="col-md-6">
            <div class="form-group">
                <label for="reviews_csv" class="form-label">
                    <i class="fas fa-file-csv"></i> 評定するレビューCSV
                </label>
                <select class="form-select" id="reviews_csv" name="reviews_csv" required>
                    {% if preset_reviews_csv %}
                        <option value="{{ preset_reviews_csv }}" selected>{{ preset_reviews_csv }}</option>
                    {% endif %}
                    {% for f in existing_reviews %}
                        {% if f != preset_reviews_csv %}
                            <option value="{{ f }}">{{ f }}</option>
                        {% endif %}
                    {% endfor %}
                    {% if not existing_reviews and not preset_reviews_csv %}
                        <option value="" disabled>レビューCSVが見つかりません</option>
                    {% endif %}
                </select>
                {% if not existing_reviews and not preset_reviews_csv %}
                    <div class="alert alert-warning mt-2">
                        <i class="fas fa-info-circle"></i>
                        まずStep1でレビューCSVを作成してください。
                    </div>
                {% endif %}
                <div class="invalid-feedback">レビューCSVを選択してください</div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="form-group">
                <label for="output_name" class="form-label">
                    <i class="fas fa-file-export"></i> 出力スコアファイル名
                </label>
                <input type="text" class="form-control" id="output_name" name="output_name" 
                       placeholder="例: my_scores" required>
                <div class="help-text">拡張子(.csv)は自動で追加されます</div>
                <div class="invalid-feedback">ファイル名を入力してください</div>
            </div>
        </div>
    </div>

    <div class="form-group">
        <label for="model_path" class="form-label">
            <i class="fas fa-brain"></i> Word2Vec モデルパス
        </label>
        <input type="text" class="form-control" id="model_path" name="model_path" 
               value="{{ default_model_path }}">
        <div class="help-text">日本語Word2Vecモデルのパスを指定してください</div>
    </div>

    {% if existing_reviews or preset_reviews_csv %}
        <div class="file-info">
            <h6><i class="fas fa-info-circle"></i> 評価軸について</h6>
            <p class="mb-0">以下の14の軸でゲームレビューを分析します：</p>
            <div class="row mt-2">
                <div class="col-md-6">
                    <small class="text-muted">
                        RPG性、アクション性、パズル性、報酬の程度、<br>
                        グラフィックのリアル性、音響効果、世界観の仮想・現実性
                    </small>
                </div>
                <div class="col-md-6">
                    <small class="text-muted">
                        キャラクターの知名度、文化の異質・同質感、<br>
                        操作のリアクション、遂行時間の長さ、<br>
                        シナリオの重要度、参加人数の多さ、ハードウェア普及度
                    </small>
                </div>
            </div>
        </div>
    {% endif %}

    <div class="text-center">
        <button type="submit" class="btn btn-primary btn-lg" 
                {% if not existing_reviews and not preset_reviews_csv %}disabled{% endif %}>
            <i class="fas fa-chart-line"></i> 評定スコアCSVを作成
        </button>
    </div>
</form>

<div class="nav-links">
    <a href="{{ url_for('step1') }}">
        <i class="fas fa-arrow-left"></i> Step 1: レビュー取得
    </a>
    {% if existing_reviews %}
        <a href="#" onclick="document.getElementById('reviews_csv').focus()">
            <i class="fas fa-list"></i> ファイル一覧を表示
        </a>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script>
// Bootstrap validation
(function() {
    'use strict';
    window.addEventListener('load', function() {
        var forms = document.getElementsByClassName('needs-validation');
        var validation = Array.prototype.filter.call(forms, function(form) {
            form.addEventListener('submit', function(event) {
                if (form.checkValidity() === false) {
                    event.preventDefault();
                    event.stopPropagation();
                }
                form.classList.add('was-validated');
            }, false);
        });
    }, false);
})();
</script>
{% endblock %}


